{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\resources\\resources\\common/assets\\resources\\resources\\common\\WsRpcClient.js"],"names":["WebSocket","window","MozWebSocket","Buffer","require","UnitTools","EventEmitter","MessagePack","WsRpcClient","self","client","url","rpc","proxy","proxyDes","serverCb","isReady","readyCb","describe","events","cbTimeOut","cbInterval","isReconnected","haveConnectd","heartBeatInterval","enbleHeartBeat","prototype","connect","binaryType","onopen","evt","sendDescribe","emit","onmessage","handleMessage","data","onclose","stopCbTimeOut","setTimeout","clearSocket","onerror","startConnectUntilConnected","startHeartCheck","setInterval","onReady","heartBeat","ok","cc","log","clearInterval","close","getDescribeList","forEach","key","value","args","length","getServerFuncArgNum","an","addRpc","rpcJson","isJson","funcName","func","Error","handleDescribe","des","runServerAction","bind","startCbTimeOut","removeEvent","message","parseDataToJson","type","runActionWithRawMessage","handleCb","cbID","cbData","hasKey","cb","remove","e","stack","handleClientClose","sendRawData","send","jsonDataToSend","sendActionData","rawData","sendData","sendCallbackData","callbackID","names","runAction","actionName","push","apply","arguments","isFunction","genID","checkRunActionArgNums","Array","slice","call","time","now","str","unit8Array","from","decode","encode","argNums","callback","readyState","on","onReadyState","off","onConnect","onClose","rmA","isTimeOut","module","exports"],"mappings":"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","file":"WsRpcClient.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\resources\\resources\\common","sourcesContent":["/**\n * Created by litengfei on 16/6/29.\n */\nvar WebSocket = WebSocket || window.WebSocket || window.MozWebSocket;\n/**\n * Created by litengfei on 16/6/14.\n */\n/**\n * Created by litengfei on 16/6/14.\n *\n */\nvar Buffer = require(\"buffer/\").Buffer\nvar UnitTools = require(\"UnitTools\");\nvar EventEmitter = require(\"EventEmitter\");\nvar MessagePack = require(\"msgpack-lite\");\nfunction WsRpcClient() {\n    var self = this;\n    this.client = null;\n    this.url = null;\n    this.rpc = {};\n    this.proxy = {};//clientProxy\n    this.proxyDes = null;\n    this.serverCb = {};\n    this.isReady = false;\n    this.readyCb = [];\n    this.describe = null;\n    this.events = new EventEmitter();\n    this.cbTimeOut =  10000;//默认15秒就算超时了，然后通知回调函数{ok:false}\n    this.cbInterval = null;\n    this.isReconnected = true;\n    this.haveConnectd = false;//已经连接过了\n    this.heartBeatInterval = null;//心跳检测周期\n    this.enbleHeartBeat = true;//是否开启心跳检测\n}\n//starServer\nWsRpcClient.prototype.connect = function (url) {\n    var self = this;\n    this.url = url;\n    this.client = new WebSocket(this.url);\n    this.client.binaryType = \"arraybuffer\";\n    this.client.onopen = function (evt) {\n        self.sendDescribe(self.client);\n        self.events.emit(\"onConnect\", self);\n    }\n    this.client.onmessage = function (evt) {\n        self.handleMessage(self.client, evt.data);\n    }\n    this.client.onclose = function (evt) {\n        self.stopCbTimeOut();\n        if (self.isReady == true) {\n            self.events.emit(\"onClose\", self);\n        }\n        setTimeout(function () {\n            if (self.isReconnected == true) {\n                self.connect(self.url);\n            }\n        }, 1000);\n        self.clearSocket();\n    }\n    this.client.onerror = function (evt) {\n        setTimeout(function () {\n            if (self.isReconnected == true) {\n                self.connect(self.url);\n            }\n        }, 1000);\n        self.clearSocket();\n    }\n}\n\n\n\nWsRpcClient.prototype.startConnectUntilConnected = function (url) {//开始连接直到连接成功，只有在第一次连接的时候生效\n    var self = this;\n    this.url = url;\n    this.client = new WebSocket(this.url);\n    this.client.binaryType = \"arraybuffer\";\n    this.client.onopen = function (evt) {\n        self.sendDescribe(self.client);\n        self.events.emit(\"onConnect\", self);\n    }\n    this.client.onmessage = function (evt) {\n        self.handleMessage(self.client, evt.data);\n    }\n    this.client.onclose = function (evt) {\n        self.stopCbTimeOut();\n        if (self.isReady == true) {//如果刚开始 连接\n            self.events.emit(\"onClose\", self);\n            self.isReady = false;\n        }\n        setTimeout(function () {\n            if (self.haveConnectd == false) {\n                self.startConnectUntilConnected(self.url);\n            }\n        }, 8000);\n        self.clearSocket();\n    }\n    this.client.onerror = function (evt) {\n        setTimeout(function () {\n            if (self.haveConnectd == false) {\n                self.startConnectUntilConnected(self.url);\n            }\n        }, 8000);\n        self.clearSocket();\n    }\n}\n\n\nWsRpcClient.prototype.startHeartCheck = function () {\n    var self = this;\n    this.heartBeatInterval = setInterval(function () {\n        if(self.haveConnectd == false)return;\n        if(self.isReady == false)return;//如果isReady为false的话，刚开始连接，或者是已经断开连接了\n        self.onReady(function (client) {\n            //发送心跳包\n            client.proxy.heartBeat(function (data) {\n                if(!data.ok){\n                    cc.log(\"没有收到心跳包！判定断线\");\n                    clearInterval(self.heartBeatInterval);\n                    self.clearSocket();\n                    self.isReady = false;\n                    //发送断开连接事件\n                    self.connect(self.url);\n                    self.events.emit(\"onClose\", self);\n                }\n            })\n        })\n    },11000);\n}\n\nWsRpcClient.prototype.clearSocket = function () {\n    if (!this.client)return;\n    this.client.onopen = null;\n    this.client.onmessage = null;\n    this.client.onclose = null;\n    this.client.onerror = null;\n    this.client.close();\n    this.client = null;\n    clearInterval(this.heartBeatInterval);\n}\n\nWsRpcClient.prototype.close = function () {\n    this.client.close();\n}\n//获得可以调用函数的列表\nWsRpcClient.prototype.getDescribeList = function () {\n    if (this.describe == null)this.describe = {};\n    else {\n        return this.describe;\n    }\n    var self = this;\n    UnitTools.forEach(this.rpc, function (key, value) {\n        self.describe[key] = {args: value.length - 1};//length-1 not need the cb arg\n    });\n    return this.describe;\n}\nWsRpcClient.prototype.getServerFuncArgNum = function (an) {\n    return this.proxyDes[an].args;\n}\n\nWsRpcClient.prototype.addRpc = function (rpcJson) {\n    var self = this;\n    if (UnitTools.isJson(rpcJson)) {\n        UnitTools.forEach(rpcJson, function (funcName, func) {\n            self.rpc[funcName] = func;\n        });\n    } else {\n        throw new Error(\"addRpc the arg must be a json\");\n    }\n}\n\nWsRpcClient.prototype.handleDescribe = function (client, data) {\n    var self = this;\n    var des = data.des;\n    this.proxyDes = des;\n    UnitTools.forEach(des, function (key, value) {\n        self.proxy[key] = self.runServerAction.bind(self, key);\n    });\n    this.startCbTimeOut();\n    this.isReady = true;\n    this.haveConnectd = true;\n    if(this.enbleHeartBeat){\n        cc.log(\"居然开启心跳包了\");\n        this.startHeartCheck();//心跳包检测\n    }\n    this.events.emit(\"onReady\", this);\n    this.events.removeEvent(\"onReady\");\n}\n//handle the client message\nWsRpcClient.prototype.handleMessage = function (client, message) {\n    var data = this.parseDataToJson(message);\n    var type = data.type;\n    switch (type) {\n        case  1://describe\n            this.handleDescribe(client, data.data);\n            break;\n        case  2://call function\n            this.runActionWithRawMessage(client, data.data);\n            break;\n        case 3://callback\n            this.handleCb(client, data.data);\n            break;\n    }\n}\n\nWsRpcClient.prototype.handleCb = function (client, data) {\n    var cbID = data.cbID;\n    var cbData = data.cbData;\n    if (UnitTools.hasKey(this.serverCb, cbID)) {\n        try {\n            this.serverCb[cbID].cb(cbData);\n            UnitTools.remove(this.serverCb, cbID);//delete call back\n        }\n        catch (e) {\n            cc.log(e.stack);\n            UnitTools.remove(this.serverCb, cbID);//delete call back\n        }\n\n    }\n}\n//handle the client close\nWsRpcClient.prototype.handleClientClose = function (client) {\n\n}\n\nWsRpcClient.prototype.sendRawData = function (client, data) {\n    client.send(this.jsonDataToSend(data));\n}\n\nWsRpcClient.prototype.sendActionData = function (client, rawData) {\n    var sendData = {};\n    sendData.type = 2;\n    sendData.data = rawData;\n    this.sendRawData(client, sendData);\n}\n\n//tell client the callbackData\nWsRpcClient.prototype.sendCallbackData = function (client, rawData, callbackID) {\n    var sendData = {};\n    sendData.type = 3;\n    sendData.data = {};\n    sendData.data.cbData = rawData;\n    sendData.data.cbID = callbackID;\n    this.sendRawData(client, sendData);\n}\n//tell client the describe\nWsRpcClient.prototype.sendDescribe = function (client) {\n    var names = this.getDescribeList();\n    var sendData = {};\n    sendData.type = 1;\n    sendData.data = {des: names};\n    this.sendRawData(client, sendData);\n}\n\nWsRpcClient.prototype.runActionWithRawMessage = function (client, data) {\n    var an = data.an;\n    var args = data.args;\n    var callbackID = data.cbID;\n    this.runAction(client, an, args, callbackID);\n}\n//run the function on server\nWsRpcClient.prototype.runAction = function (client, actionName, args, callbackID) {\n    var self = this;\n    if (UnitTools.hasKey(this.rpc, actionName) == false) {\n        throw new Error(\"server call function \" + actionName + \" is not defined\");\n    }\n    args.push(function (cbData) {\n        //tell the client cb Data\n        if (callbackID == 0)return;//cbID is 0 means no client no callback\n        self.sendCallbackData(client, cbData, callbackID);\n    });\n    this.rpc[actionName].apply(this, args);\n}\n\n//run client action first arg is bind to actionName  last is to be callback\nWsRpcClient.prototype.runServerAction = function (an) {\n    var length = arguments.length;\n    var cb = arguments[length - 1];\n    var cbID = UnitTools.isFunction(cb) ? UnitTools.genID() : 0;\n    if (cbID == 0 && !this.checkRunActionArgNums(an, length - 1)) {\n        cc.log(\"server func \" + \"no callback need \" + this.getServerFuncArgNum(an) + \" args\");\n        return\n    }\n    else if (cbID != 0 && !this.checkRunActionArgNums(an, length - 2)) {\n        cc.log(\"server func \" + an + \" need \" + this.getServerFuncArgNum(an) + \" args\");\n        return;\n    }\n    var sendData = {};\n    var cb = arguments[length - 1];\n    sendData.cbID = cbID;\n    sendData.args = Array.prototype.slice.call(arguments, 1, length - 1 + !cbID);\n    sendData.an = arguments[0];\n    if (sendData.cbID != 0) {\n        this.serverCb[sendData.cbID] = {cb: cb, time: UnitTools.now()};\n    }\n    this.sendActionData(this.client, sendData);\n}\n\nWsRpcClient.prototype.parseDataToJson = function (str) {\n\n    var unit8Array = Buffer.from(str);\n    return MessagePack.decode(unit8Array);\n    //return JSON.parse(str);\n}\n\nWsRpcClient.prototype.jsonDataToSend = function (data) {\n    return MessagePack.encode(data);\n    //return JSON.stringify(data);\n}\n\n\nWsRpcClient.prototype.checkRunActionArgNums = function (an, argNums) {\n    if (this.proxyDes[an].args != argNums)return false;\n    return true;\n}\n\n//返回是否连接\nWsRpcClient.prototype.onReady = function (callback) {\n    if (this.isReady == false || this.client.readyState != 1) {\n        this.isReady = false;\n        this.events.on(\"onReady\", callback);\n        return;\n    }\n    else {\n        callback(this);\n    }\n}\n\nWsRpcClient.prototype.onReadyState = function(cb){\n    if (this.isReady == false || this.client.readyState != 1) {\n        cb(false);\n    }\n    else {\n        cb(true);\n    }\n}\n\nWsRpcClient.prototype.off = function (callback) {\n    this.events.remove(callback);\n}\n\nWsRpcClient.prototype.onConnect = function (callback) {\n    this.events.on(\"onConnect\", callback);\n}\n\n\nWsRpcClient.prototype.onClose = function (callback) {\n    this.events.on(\"onClose\", callback);\n}\n\nWsRpcClient.prototype.startCbTimeOut = function () {\n    var self = this;\n    this.cbInterval = setInterval(function () {\n        var rmA = [];\n        UnitTools.forEach(self.serverCb, function (key, value) {\n            if (UnitTools.isTimeOut(value.time, self.cbTimeOut)) {\n                rmA.push(key);\n            }\n        });\n        if (rmA.length == 0)return;\n        UnitTools.forEach(rmA, function (key, value) {\n            try{\n                self.serverCb[value].cb({ok:false})\n                cc.log(\"调用超时!\");\n            }catch(e){\n\n            }\n            UnitTools.remove(self.serverCb, value);\n        });\n    }, this.cbTimeOut);\n}\n\nWsRpcClient.prototype.stopCbTimeOut = function () {\n    //所有等待回调的函数，都通知为false，因为断开连接了\n    UnitTools.forEach(this.serverCb,function (key,value) {\n       try{\n           value.cb({ok:false});\n           cc.log(\"连接关闭了，但是还没调用!\");\n       }catch(e){\n\n       }\n    });\n    clearInterval(this.cbInterval);\n}\nmodule.exports = WsRpcClient;"]}