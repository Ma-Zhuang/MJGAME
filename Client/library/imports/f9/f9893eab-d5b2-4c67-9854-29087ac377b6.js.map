{"version":3,"sources":["..\\..\\..\\..\\..\\..\\assets\\resources\\resources\\common/assets\\resources\\resources\\common\\AutoReconnectWsRpcClient.js"],"names":["WsRpcClient","require","EventEmitter","AutoReconnectWsRpcClient","self","client","enbleHeartBeat","events","isReady","proxy","rpcService","url","cc","eventManager","addCustomListener","game","EVENT_SHOW","setTimeout","checkHeartBeatAndReconnect","bind","prototype","connect","clearSocket","e","isReconnected","addRpc","startConnectUntilConnected","onClose","emit","stopCheckHeartBeart","onReady","startCheckHeartBeat","removeEvent","heartBeatInterVal","setInterval","clearInterval","timeOut","log","isConnected","heartBeat","data","ok","service","cb","on","onReadyState","close","off","remove","clear","module","exports"],"mappings":";;;;;;AAAA;;;AAGA,IAAIA,cAAcC,QAAQ,aAAR,CAAlB;AACA,IAAIC,eAAeD,QAAQ,cAAR,CAAnB;AACA;AACA,SAASE,wBAAT,GAAmC;AAC/B,QAAIC,OAAO,IAAX;AACA,SAAKC,MAAL,GAAc,IAAIL,WAAJ,EAAd;AACA,SAAKK,MAAL,CAAYC,cAAZ,GAA6B,KAA7B;AACA,SAAKC,MAAL,GAAc,IAAIL,YAAJ,EAAd;AACA,SAAKM,OAAL,GAAe,KAAf;AACA,SAAKC,KAAL,GAAa,IAAb;AACA,SAAKC,UAAL,GAAkB,IAAlB;AACA,SAAKC,GAAL,GAAW,IAAX;;AAEA;AACA,QAAGC,MAAMA,GAAGC,YAAZ,EAAyB;AACrBD,WAAGC,YAAH,CAAgBC,iBAAhB,CAAkCF,GAAGG,IAAH,CAAQC,UAA1C,EAAsD,YAAU;AAC5DC,uBAAW,YAAY;AACnBb,qBAAKc,0BAAL,CAAgC,IAAhC;AACH,aAFU,CAETC,IAFS,CAEJf,IAFI,CAAX,EAEa,EAFb;AAGH,SAJqD,CAIpDe,IAJoD,CAI/C,IAJ+C,CAAtD;AAKH;AAGJ;;AAEDhB,yBAAyBiB,SAAzB,CAAmCC,OAAnC,GAA6C,UAASV,GAAT,EAAa;AACtD,QAAG,KAAKN,MAAL,IAAe,IAAlB,EAAuB;AACnB,YAAG;AACC,iBAAKA,MAAL,CAAYiB,WAAZ,GADD,CAC2B;AAC7B,SAFD,CAEC,OAAMC,CAAN,EAAS,CAET;AACJ;AACD,SAAKZ,GAAL,GAAWA,GAAX;AACA,SAAKN,MAAL,CAAYC,cAAZ,GAA6B,KAA7B;AACA,SAAKD,MAAL,CAAYmB,aAAZ,GAA4B,KAA5B;AACA,SAAKnB,MAAL,CAAYoB,MAAZ,CAAmB,KAAKf,UAAxB;AACA,SAAKL,MAAL,CAAYqB,0BAAZ,CAAuCf,GAAvC;AACA,SAAKN,MAAL,CAAYsB,OAAZ,CAAoB,UAAStB,MAAT,EAAgB;AAChC,aAAKG,OAAL,GAAe,KAAf;AACA,aAAKC,KAAL,GAAa,IAAb;AACA,aAAKF,MAAL,CAAYqB,IAAZ,CAAiB,SAAjB,EAA2BvB,MAA3B;AACA,aAAKA,MAAL,GAAc,IAAIL,WAAJ,EAAd;AACA,aAAKK,MAAL,CAAYC,cAAZ,GAA6B,KAA7B;AACA,aAAKD,MAAL,CAAYmB,aAAZ,GAA4B,KAA5B;AACA,aAAKK,mBAAL,GAPgC,CAOL;AAC3B,aAAKR,OAAL,CAAa,KAAKV,GAAlB;AACH,KATmB,CASlBQ,IATkB,CASb,IATa,CAApB;AAUA,SAAKd,MAAL,CAAYyB,OAAZ,CAAoB,YAAU;AAC1B,aAAKC,mBAAL,GAD0B,CACC;AAC3B,aAAKvB,OAAL,GAAe,IAAf;AACA,aAAKC,KAAL,GAAa,KAAKJ,MAAL,CAAYI,KAAzB;AACA,aAAKF,MAAL,CAAYqB,IAAZ,CAAiB,SAAjB,EAA2B,KAAKvB,MAAhC;AACA,aAAKE,MAAL,CAAYyB,WAAZ,CAAwB,SAAxB;AAEH,KAPmB,CAOlBb,IAPkB,CAOb,IAPa,CAApB;AAQH,CA/BD;;AAiCAhB,yBAAyBiB,SAAzB,CAAmCW,mBAAnC,GAAyD,YAAY;AACjE,QAAI3B,OAAO,IAAX;AACA,SAAK6B,iBAAL,GAAyBC,YAAY,YAAY;AAC7C9B,aAAKc,0BAAL,CAAgC,KAAhC;AACH,KAFwB,EAEvB,KAFuB,CAAzB;AAGH,CALD;;AAOAf,yBAAyBiB,SAAzB,CAAmCS,mBAAnC,GAAyD,YAAY;AACjEM,kBAAc,KAAKF,iBAAnB;AACH,CAFD;;AAKA9B,yBAAyBiB,SAAzB,CAAmCF,0BAAnC,GAAgE,UAAUkB,OAAV,EAAmB;AAC/ExB,OAAGyB,GAAH,CAAO,UAAP;AACA,QAAIjC,OAAO,IAAX;AACA,QAAIkC,cAAc,KAAlB;AACAlC,SAAKC,MAAL,CAAYyB,OAAZ,CAAoB,YAAY;AAC5B1B,aAAKC,MAAL,CAAYI,KAAZ,CAAkB8B,SAAlB,CAA4B,UAAUC,IAAV,EAAgB;AACxC,gBAAGA,KAAKC,EAAR,EAAYH,cAAc,IAAd;AACf,SAFD;AAGH,KAJD;AAKArB,eAAW,YAAY;AACnB,YAAGqB,eAAe,KAAf,IAAwBlC,KAAKI,OAAL,IAAgB,IAA3C,EAAgD;AAC5CJ,iBAAKI,OAAL,GAAe,KAAf;AACA;AACAJ,iBAAKK,KAAL,GAAa,IAAb;AACAL,iBAAKyB,mBAAL;AACAzB,iBAAKC,MAAL,CAAYiB,WAAZ;AACAlB,iBAAKG,MAAL,CAAYqB,IAAZ,CAAiB,SAAjB,EAA2BxB,KAAKC,MAAhC;AACAD,iBAAKC,MAAL,GAAc,IAAIL,WAAJ,EAAd;AACAI,iBAAKiB,OAAL,CAAajB,KAAKO,GAAlB;AACH;AACJ,KAXD,EAWEyB,OAXF;AAYH,CArBD;;AAuBAjC,yBAAyBiB,SAAzB,CAAmCK,MAAnC,GAA4C,UAASiB,OAAT,EAAiB;AACzD,SAAKhC,UAAL,GAAkBgC,OAAlB;AACH,CAFD;;AAIAvC,yBAAyBiB,SAAzB,CAAmCU,OAAnC,GAA6C,UAASa,EAAT,EAAY;AACrD,QAAG,KAAKnC,OAAR,EAAgB;AACZ,aAAKH,MAAL,CAAYyB,OAAZ,CAAoBa,EAApB;AACH,KAFD,MAEK;AACD,aAAKpC,MAAL,CAAYqC,EAAZ,CAAe,SAAf,EAAyBD,EAAzB;AACH;AACJ,CAND;AAOAxC,yBAAyBiB,SAAzB,CAAmCyB,YAAnC,GAAkD,UAASF,EAAT,EAAY;AAC1D,SAAKtC,MAAL,CAAYwC,YAAZ,CAAyBF,EAAzB;AACH,CAFD;;AAIAxC,yBAAyBiB,SAAzB,CAAmCO,OAAnC,GAA6C,UAASgB,EAAT,EAAY;AACrD;AACA,SAAKpC,MAAL,CAAYqC,EAAZ,CAAe,SAAf,EAAyBD,EAAzB;AACH,CAHD;;AAKAxC,yBAAyBiB,SAAzB,CAAmC0B,KAAnC,GAA2C,YAAU;AACjD,SAAKzC,MAAL,CAAYyC,KAAZ;AACH,CAFD;;AAIA3C,yBAAyBiB,SAAzB,CAAmC2B,GAAnC,GAAyC,UAASJ,EAAT,EAAY;AACjD,SAAKpC,MAAL,CAAYyC,MAAZ,CAAmBL,EAAnB;AACH,CAFD;;AAIAxC,yBAAyBiB,SAAzB,CAAmC6B,KAAnC,GAA2C,YAAY;AACnD,SAAK1C,MAAL,GAAc,IAAd;AACA,QAAG,KAAKF,MAAR,EAAe;AACX,aAAKA,MAAL,CAAYiB,WAAZ;AACH;AACJ,CALD;;AAOA4B,OAAOC,OAAP,GAAiBhD,wBAAjB","file":"AutoReconnectWsRpcClient.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\resources\\resources\\common","sourcesContent":["/**\n * Created by litengfei on 16/12/7.\n */\nvar WsRpcClient = require(\"WsRpcClient\");\nvar EventEmitter = require(\"EventEmitter\");\n//自动连接的WsRpcClient\nfunction AutoReconnectWsRpcClient(){\n    var self = this;\n    this.client = new WsRpcClient();\n    this.client.enbleHeartBeat = false;\n    this.events = new EventEmitter();\n    this.isReady = false;\n    this.proxy = null;\n    this.rpcService = null;\n    this.url = null;\n\n    //添加从外面切换回来的事件\n    if(cc && cc.eventManager){\n        cc.eventManager.addCustomListener(cc.game.EVENT_SHOW, function(){\n            setTimeout(function () {\n                self.checkHeartBeatAndReconnect(1000);\n            }.bind(self),50);\n        }.bind(this));\n    }\n\n\n}\n\nAutoReconnectWsRpcClient.prototype.connect = function(url){\n    if(this.client != null){\n        try{\n            this.client.clearSocket();//清除网络事件\n        }catch(e) {\n\n        }\n    }\n    this.url = url;\n    this.client.enbleHeartBeat = false;\n    this.client.isReconnected = false;\n    this.client.addRpc(this.rpcService);\n    this.client.startConnectUntilConnected(url);\n    this.client.onClose(function(client){\n        this.isReady = false;\n        this.proxy = null;\n        this.events.emit(\"onClose\",client);\n        this.client = new WsRpcClient();\n        this.client.enbleHeartBeat = false;\n        this.client.isReconnected = false;\n        this.stopCheckHeartBeart();//停止心跳检测\n        this.connect(this.url);\n    }.bind(this));\n    this.client.onReady(function(){\n        this.startCheckHeartBeat();//开始心跳检测\n        this.isReady = true;\n        this.proxy = this.client.proxy;\n        this.events.emit(\"onReady\",this.client);\n        this.events.removeEvent(\"onReady\");\n\n    }.bind(this));\n}\n\nAutoReconnectWsRpcClient.prototype.startCheckHeartBeat = function () {\n    var self = this;\n    this.heartBeatInterVal = setInterval(function () {\n        self.checkHeartBeatAndReconnect(10000);\n    },11000);\n}\n\nAutoReconnectWsRpcClient.prototype.stopCheckHeartBeart = function () {\n    clearInterval(this.heartBeatInterVal);\n}\n\n\nAutoReconnectWsRpcClient.prototype.checkHeartBeatAndReconnect = function (timeOut) {\n    cc.log(\"进入开始检测阶段\");\n    var self = this;\n    var isConnected = false;\n    self.client.onReady(function () {\n        self.client.proxy.heartBeat(function (data) {\n            if(data.ok) isConnected = true;\n        })\n    })\n    setTimeout(function () {\n        if(isConnected == false && self.isReady == true){\n            self.isReady = false;\n            //发送断开连接事件\n            self.proxy = null;\n            self.stopCheckHeartBeart();\n            self.client.clearSocket();\n            self.events.emit(\"onClose\",self.client);\n            self.client = new WsRpcClient();\n            self.connect(self.url);\n        }\n    },timeOut);\n}\n\nAutoReconnectWsRpcClient.prototype.addRpc = function(service){\n    this.rpcService = service;\n}\n\nAutoReconnectWsRpcClient.prototype.onReady = function(cb){\n    if(this.isReady){\n        this.client.onReady(cb);\n    }else{\n        this.events.on(\"onReady\",cb);\n    }\n}\nAutoReconnectWsRpcClient.prototype.onReadyState = function(cb){\n    this.client.onReadyState(cb);\n}\n\nAutoReconnectWsRpcClient.prototype.onClose = function(cb){\n    //重新连接\n    this.events.on(\"onClose\",cb);\n}\n\nAutoReconnectWsRpcClient.prototype.close = function(){\n    this.client.close();\n}\n\nAutoReconnectWsRpcClient.prototype.off = function(cb){\n    this.events.remove(cb);\n}\n\nAutoReconnectWsRpcClient.prototype.clear = function () {\n    this.events = null;\n    if(this.client){\n        this.client.clearSocket();\n    }\n}\n\nmodule.exports = AutoReconnectWsRpcClient;\n"]}